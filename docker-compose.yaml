version: "3.8"

services:
  # ------------------------------------------------------
  # PostgreSQL (for RAG + pgvector data)
  # ------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg15
    container_name: postgres
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: rag_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # ------------------------------------------------------
  # MLFlow Tracking Server
  # ------------------------------------------------------

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.11.1
    container_name: mlflow
    ports:
      - "5000:5000"
    entrypoint:
      - sh
      - -c
      - |
        mlflow server \
          --backend-store-uri sqlite:///mlflow.db \
          --default-artifact-root /tmp/mlruns \
          --host 0.0.0.0 \
          --port 5000
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:5000')"
        ]
      interval: 5s
      timeout: 5s
      retries: 10





  # ------------------------------------------------------
  # Airflow DB + user initialization (runs once)
  # ------------------------------------------------------
  airflow-init:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow-init
    depends_on:
      - postgres
    environment:
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      DATABASE_URL: postgresql://airflow:airflow@postgres:5432/rag_db
    volumes:
      - ./airflow:/opt/airflow
      - ./:/opt/project
    command: >
      bash -c "
      airflow db init &&
      airflow users create
        --username admin
        --password admin
        --firstname Admin
        --lastname User
        --role Admin
        --email admin@example.com || true
      "

  # ------------------------------------------------------
  # Airflow Webserver
  # ------------------------------------------------------
  airflow-webserver:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow-webserver
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      mlflow:
        condition: service_healthy
    environment:
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      PYTHONPATH: /opt/project
      DATABASE_URL: postgresql://airflow:airflow@postgres:5432/rag_db
      MLFLOW_TRACKING_URI: http://mlflow:5000
    volumes:
      - ./airflow:/opt/airflow
      - ./airflow/dags:/opt/airflow/dags
      - ./:/opt/project
    ports:
      - "8080:8080"
    command: airflow webserver

  # ------------------------------------------------------
  # Airflow Scheduler
  # ------------------------------------------------------
  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow-scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      mlflow:
        condition: service_healthy
    environment:
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      PYTHONPATH: /opt/project
      DATABASE_URL: postgresql://airflow:airflow@postgres:5432/rag_db
      MLFLOW_TRACKING_URI: http://mlflow:5000
    volumes:
      - ./airflow:/opt/airflow
      - ./airflow/dags:/opt/airflow/dags
      - ./:/opt/project
    command: airflow scheduler

volumes:
  postgres_data:
